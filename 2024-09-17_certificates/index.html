<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CET 93</title>
  </head>
  <body>
    <h1>2024-09-17 Certificados HTTPS</h1>

    <nav>
      <ul>
      <li>
        <a href="#salvaguardar-configuracoes">Salvaguardar configurações</a>
      </li>
      <li><a href="#adicionar-autoridade">Adicionar Autoridade</a></li>
      <li><a href="#editar-a-autoridade">Editar a Autoridade</a></li>
      <li>
        <a href="#resultado-da-criacao-da-autoridade"
        >Resultado da criação da Autoridade</a
        >
      </li>
      <li><a href="#criar-certificado">Criar Certificado</a></li>
      <li><a href="#editar-a-certificado">Editar a Certificado</a></li>
      <li><a href="#exportar-certificados">Exportar Certificados</a></li>
      <li>
        <a href="#instalar-autoridade-de-certificadora-no-windows"
        >Instalar Autoridade de Certificadora no Windows</a
        >
      </li>
      <li>
        <a href="#instalar-o-certificado-no-windows"
        >Instalar o Certificado no Windows</a
        >
      </li>
      <li>
        <a href="#instalacao-de-certificados-troubleshooting"
        >Instalação de Certificados - Troubleshooting</a
        >
      </li>
      <li>
        <a href="#ativacao-do-https-no-pfsense">Ativação do HTTPS no PFSENSE</a>
      </li>
      <li><a href="#verificacao-do-https">Verificação do HTTPS</a></li>
      <li><a href="#criacao-de-ou">Criação de OU</a></li>
      <li>
        <a href="#criacao-de-utilizador-dentro-da-ou"
        >Criação de utilizador dentro da OU</a
        >
      </li>
      <li><a href="#criacao-da-group-policy">Criação da Group Policy</a></li>
      </ul>
    </nav>

    <div>
      <h2>Salvaguardar configurações</h2>
      <p>
        Antes de proceder à criação dos certificados deve-se salvaguardar a
        configuração da máquina, através de "Clone" ou "Snapshot" (se for uma
        VM) ou salvaguardando as configurações da máquina.
      </p>
      <div style="text-align: center">
        <img
          src="./image/pfsense_save_configuration.png"
          alt="1"
          style="width: 50%"
        />
      </div>
    </div>

    <div>
      <h2>Adicionar Autoridade</h2>
      <p>Ir até System\Certificate\Authorities e selecionar ADD.</p>
      <div style="text-align: center">
        <img
          src="./image/pfsense_add_authority.png"
          alt="1"
          style="width: 50%"
        />
      </div>
    </div>

    <div>
      <h2>Editar a Autoridade</h2>
      <p>Preencher os seguintes campos:</p>
      <ul>
        <li>Descriptive name: Certificado para a empresa hacking.com</li>
        <li>Method: Create an internal Certificate Authority</li>
        <li>Digest Algorithm: sha256</li>
        <li>Lifetime (days): 3560</li>
        <li>Common Name: Certificado para a empresa hacking.com</li>
        <li>Country Code: PT</li>
        <li>State or Province: Lisboa</li>
        <li>City: Lisboa</li>
        <li>Organization: hacking.com</li>
      </ul>
      <div style="text-align: center">
        <img
          src="./image/pfsense_authority_edit.png"
          alt="1"
          style="width: 50%"
        />
      </div>
    </div>

    <div>
      <h2>Resultado da criação da Autoridade</h2>
      <p>Preencher os seguintes campos:</p>
      <div style="text-align: center">
        <img
          src="./image/pfsense_authority_result.png"
          alt="1"
          style="width: 50%"
        />
      </div>
    </div>

    <div>
      <h2>Criar Certificado</h2>
      <p>Selecionar Add/Sign:</p>
      <div style="text-align: center">
        <img
          src="./image/pfsense_certificate_create.png"
          alt="1"
          style="width: 50%"
        />
      </div>
    </div>

    <div>
      <h2>Editar a Certificado</h2>
      <p>Preencher os seguintes campos:</p>
      <ul>
        <li>Descriptive name: Certificado https pfsense</li>
        <li>Common Name: Certificado https pfsense</li>
        <li>Certificate Type: Server Certificate</li>
        <li>Alternative Names: FQDN or Hostname - pfsense.hacking.com</li>
        <li>Alternative Names: IP Address - 172.20.27.254</li>
      </ul>
      <div style="text-align: center">
        <img
          src="./image/pfsense_certificate_edit.png"
          alt="1"
          style="width: 50%"
        />
      </div>
    </div>

    <div>
      <h2>Exportar Certificados</h2>
      <p>Autoridade Certificadora:</p>
      <div style="text-align: center">
        <img
          src="./image/pfsense_autority_export.png"
          alt="1"
          style="width: 50%"
        />
      </div>
      <p>Certificado:</p>
      <div style="text-align: center">
        <img
          src="./image/pfsense_certificate_export.png"
          alt="1"
          style="width: 50%"
        />
      </div>
    </div>

    <div>
      <h2>Instalar Autoridade de Certificadora no Windows</h2>
      <p>Abrir Certificado da Empresa:</p>
      <div style="text-align: center">
        <img
          src="./image/windows_authority_install.png"
          alt="1"
          style="width: 50%"
        />
      </div>
      <p>Instalar em Local Machine:</p>
      <div style="text-align: center">
        <img
          src="./image/windows_authority_install_01.png"
          alt="1"
          style="width: 50%"
        />
      </div>
      <p>Selecionar "Trusted Root Certification Authorities":</p>
      <div style="text-align: center">
        <img
          src="./image/windows_authority_install_02.png"
          alt="1"
          style="width: 50%"
        />
      </div>  
      <p>Depois de terminada a instalação recebemos uma mensagem de que o processo terminou com sucesso:</p>
      <div style="text-align: center">
        <img
          src="./image/windows_authority_install_03.png"
          alt="1"
          style="width: 50%"
        />
      </div>
    </div>

    <div>
      <h2>Instalar o Certificado no Windows</h2>
      <p>Para instalar o certificado, repetimos o processo realizado para a Empresa Certificadora. </p>
      <div style="text-align: center">
        <img
          src="./image/windows_authority_install.png"
          alt="1"
          style="width: 50%"
        />
      </div>
      <p>Instalar em Local Machine:</p>
      <div style="text-align: center">
        <img
          src="./image/windows_authority_install_01.png"
          alt="1"
          style="width: 50%"
        />
      </div>
      <p>Selecionar "Trusted Root Certification Authorities":</p>
      <div style="text-align: center">
        <img
          src="./image/windows_authority_install_02.png"
          alt="1"
          style="width: 50%"
        />
      </div>  
      <p>Depois de terminada a instalação recebemos uma mensagem de que o processo terminou com sucesso:</p>
      <div style="text-align: center">
        <img
          src="./image/windows_authority_install_03.png"
          alt="1"
          style="width: 50%"
        />
      </div>
    </div>

    <div>
      <h2>Instalação de Certificados - Troubleshooting</h2>
      <p>Para confirmarmos que a instalação foi bem sucedida, executamos o snap-in certlm.msc
        onde coirmamos que os certificados estão bem instalados:</p>
      <div style="text-align: center">
        <img
          src="./image/windows_certificate_mmc.png"
          alt="1"
          style="width: 50%"
        />
      </div>
    </div>

    <div>
      <h2>Ativação do HTTPS no PFSENSE</h2>
      <p>Ir até System\Advanced\Admin Access e selecionar a opção HTTPS (SSL/TLS), 
        inserir um TCP Port (22000), de seguida selecionar Save:</p>
      <div style="text-align: center">
        <img
          src="./image/pfsense_https.png"
          alt="1"
          style="width: 50%"
        />
      </div>
    </div>    
    
    <div>
      <h2>Verificação do HTTPS</h2>
      <p>No browser onde instalámos os certificados, abrimos uma página do browser,
        com o ip do PFSENSE e o TCP port específicado no ponto anterior :</p>
      <div style="text-align: center">
        <img
          src="./image/pfsense_certificate_validate.png"
          alt="1"
          style="width: 50%"
        />
      </div>
      <p>Conteúdo do certificado no browser:</p>
      <div style="text-align: center">
        <img
          src="./image/pfsense_browser_certificate.png"
          alt="1"
          style="width: 50%"
        />
      </div>      
    </div>    

    <div>
      <h2>Criação de OU</h2>
      <p>Numa rede Windows, para replicarmos automaticamente os certificados,
        criamos OUs (Unidades Organizacionais):</p>
      <div style="text-align: center">
        <img
          src="./image/windows_new_ou.png"
          alt="1"
          style="width: 50%"
        />
      </div>
    </div>    

    <div>
      <h2>Criação de utilizador dentro da OU</h2>
      <p>Adicionamos os utilizadores à OU:</p>
      <div style="text-align: center">
        <img
          src="./image/windows_new_user.png"
          alt="1"
          style="width: 50%"
        />
      </div>
      <p>Definimos uma password, para a nova conta de utilizador:</p>
      <div style="text-align: center">
        <img
          src="./image/windows_new_user_password.png"
          alt="1"
          style="width: 50%"
        />
      </div>      
    </div>

    <div>
      <h2>Criação da Group Policy</h2>
      <p>Abrimos o snap-in Group Policy Management (gpmc.msc), na opção Default DOmain Policies,
        selecionamos Edit:</p>
      <div style="text-align: center">
        <img
          src="./image/windows_group_policy_management.png"
          alt="1"
          style="width: 50%"
        />
      </div>

      <p>Selecionamos Computer Configuration\Policies\Windows Settings\Security Settings\
        Public Key Policies\Trusted Root Certification Authorities, e com o botão direito do rato selecionamos a opção Import...:</p>
      <div style="text-align: center">
        <img
          src="./image/windows_gpo.png"
          alt="1"
          style="width: 50%"
        />
      </div>

      <p>Selecionamos Next na janela que aparece:</p>
      <div style="text-align: center">
        <img
          src="./image/windows_certificate_import.png"
          alt="1"
          style="width: 50%"
        />
      </div>

      <p>Abrimos o ficheiro referente ao certificado para a empresa, depois é só fazer Next, Next e Finish:</p>
      <div style="text-align: center">
        <img
          src="./image/windows_gpo_open_certificate.png"
          alt="1"
          style="width: 50%"
        />
      </div>

      <p>Abrimos o ficheiro referente ao certificado para a empresa, depois é só fazer Next, Next e Finish:</p>
      <div style="text-align: center">
        <img
          src="./image/windows_gpo_open_certificate.png"
          alt="1"
          style="width: 50%"
        />
      </div>

      <p>Recebemos por fim uma mensagem a iindicar que o processo, foi executado com sucesso.
        De seguida executamos o mesmo processo para o outro certificado:</p>
      <div style="text-align: center">
        <img
          src="./image/windows_certificate_finish.png"
          alt="1"
          style="width: 50%"
        />
      </div>

      <p>Na linha de comandos do Windows Server, executamos o comando Gpupdate /force (executar este comando 3 vezes, porque estamos a executar o windows em VM. De seguida fazer um restar ao Windows 10):</p>
      <div style="text-align: center">
        <img
          src="./image/windows_gpupdate.png"
          alt="1"
          style="width: 50%"
        />
      </div>
      
      <p>Depois de reiniciar o Windows, se acedermos ao site do PFSENSE, pode verificar que o certificado foi instalado com sucesso:</p>
      <div style="text-align: center">
        <img
          src="./image/windows_browser_certificate.png"
          alt="1"
          style="width: 50%"
        />
      </div>
    </div>

  </body>
</html>
